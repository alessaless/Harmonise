<!doctype html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Progressi alunno</title>

  <link rel="stylesheet" href="header.css">
  <link rel="stylesheet" href="homepageEducatore.css">
  <link rel="stylesheet" href="AggiungiBambino.css">

  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" href="logo.ico" sizes="any">
  <link rel="icon" href="logo.svg" type="image/svg+xml">
  <link rel="apple-touch-icon" href="logo.png">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">

  <meta name="theme-color" content="#fafafa">
  <style>
    .title-bar {
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      margin: 1.5rem 1.3rem 1.3rem;
    }

    .title-bar h2 {
      flex: 1;
      text-align: center;
      margin: 0;
    }

    .title-bar .back-btn {
      position: absolute;
      right: 0;  /* lo spinge tutto a destra */
    }

    body {
      background:white;
      font-family: Inter, sans-serif;
    }

    #exerciseList {
      margin-top: 1rem;
      padding: 20px;
    }

    .execution-card {
      border: 1px solid #ddd;
      padding: 0.8rem;
      border-radius: 8px;
      margin-bottom: 0.8rem;
      background: #99CCFF;
    }

    h2 {
      text-align: center;
      margin: 0.5rem;
    }

    canvas {
      display: block;
      max-width: 400px;
      width: 90%;
      margin: 0.5rem auto;
    }

    #retryButton {
      display: block;
      margin: 1rem auto;
      padding: 0.5rem 1rem;
      font-size: 1rem;
      border-radius: 6px;
      cursor: pointer;
    }
    .back-btn {
      display: block;
      margin: 1rem 0 1rem auto;
      padding: 0.8rem 1.5rem;
      font-size: 1.2rem;
      font-weight: bold;
      background-color: #99CCFF; /* verde */
      color: black;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }

    .back-btn:hover {
      background-color: #72A5CB;
    }

  </style>
</head>
<body>
<div id="header-placeholder"></div>
<div class="title-bar">
  <h2 id="pageTitle">Progressi</h2>
  <button onclick="history.back()" class="back-btn">⬅ Torna indietro</button>
</div>
<canvas id="progressChart" width="300" height="300"></canvas>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<section id="exerciseList"></section>

<script>
  // Caricamento header
  fetch("header.html")
          .then(res => res.text())
          .then(data => { document.getElementById("header-placeholder").innerHTML = data; });

  const child = JSON.parse(localStorage.getItem("selectedChild"));
  const token = localStorage.getItem("token");

  document.getElementById("pageTitle").textContent = "Progressi di " + child.nome + " " + child.cognome;

  const ctx = document.getElementById("progressChart").getContext("2d");
  const progressChart = new Chart(ctx, {
    type: "doughnut",
    data: {
      labels: ["Completati", "Non completati"],
      datasets: [{
        data: [0, 0],
        backgroundColor: ["#4caf50", "#f44336"]
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      plugins: { legend: { position: "bottom" } }
    }
  });

  function aggiornaGrafico(completati, nonCompletati) {
    progressChart.data.datasets[0].data = [completati, nonCompletati];
    progressChart.update();
  }

  async function loadExecutions() {
    try {
      const res = await fetch(`http://localhost:8080/executions/child/${child.id}`, {
        headers: {
          "Content-Type": "application/json",
          "Authorization": "Bearer " + token
        },
      });
      if (!res.ok) throw new Error("Errore nel caricamento esecuzioni");

      const executions = await res.json();
      const container = document.getElementById("exerciseList");
      container.innerHTML = "";

      if (executions.length === 0) {
        container.textContent = "Nessun esercizio eseguito al momento.";
        aggiornaGrafico(0,0);
        return;
      }

      // Ordinamento per data discendente
      executions.sort((a, b) => new Date(b.dataEsecuzione) - new Date(a.dataEsecuzione));

      let completati = 0;
      let nonCompletati = 0;

      executions.forEach(exec => {
        const card = document.createElement("div");
        card.className = "execution-card";
        card.setAttribute("aria-label", `Esercizio ${exec.idEsercizio}, ${exec.terminato === "Y" ? "completato" : "non completato"}`);

        const terminato = exec.terminato === "Y";
        if (terminato) completati++; else nonCompletati++;

        card.innerHTML = `
          <p><strong>ID Esercizio:</strong> ${exec.idEsercizio}</p>
          <p><strong>Data:</strong> ${new Date(exec.dataEsecuzione).toLocaleString()}</p>
          <p><strong>Errori:</strong> ${exec.numeroErrori}</p>
          <p><strong>Livelli completati:</strong> ${exec.livelliCompletati}</p>
          <p><strong>Stato:</strong> ${terminato ? "✅ Completato" : "❌ Non completato"}</p>
        `;
        container.appendChild(card);
      });

      aggiornaGrafico(completati, nonCompletati);
    } catch (err) {
      console.error(err);
      const container = document.getElementById("exerciseList");
      container.innerHTML = "Errore nel caricamento progressi.";
      const retryButton = document.createElement("button");
      retryButton.id = "retryButton";
      retryButton.textContent = "Riprova";
      retryButton.onclick = loadExecutions;
      container.appendChild(retryButton);
    }
  }

  loadExecutions();
</script>
</body>
</html>
